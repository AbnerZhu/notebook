# 微信公众平台开发

## 概述

### 简介

为了识别用户， 每个用户针对每个公众号会产生一个安全的 OpenID， 如果需要在多公众号、移动应用之间做用户共通，则需前往微信开放平台，将这些公众号和应用绑定到一个开放平台账号下，绑定后，一个用户虽然对多个公众号和应用有多个不同的OpenID，但他对所有这些同一开放平台账号下的公众号和应用，只有一个UnionID。

**需注意**：

- 微信公众平台开发是指为微信公众号进行业务开发， 为移动应用、 PC 端网站、 公众号第三方平台（为各行各业公众号运营者提供服务）的开发。
- 在申请到认证公众号之前， 可以先通过测试号申请系统， 快速申请一个测试接口号， 立即开始接口测试开发
- 在开发过程中， 可以使用接口调试工具来在线调试某些接口
- 每个接口都有每日接口调用频次限制， 可以在公众平台官网-开发者中心处查看具体频次
- 在开发出现问题是， 可以通过接口调用的返回码， 以及报警排查指引（在公众号平台官网-开发者中心处可以设置接口报警）， 来发现和解决问题
- 公众平台以 access_token 为借口调用凭据， 来调用借口， 所有接口的调用需要先获取 access_token， access_token 在 2 小时内有效， 过期需要重新获取， 但 1 天内获取次数有限， 开发者需自行存储。
- 公众平台接口调用仅支持 80 端口

公众号主要通过公众号消息会话和公众号内网页来用户提供服务的。

- 公众号消息会话

  公众号是以微信用户的一个联系人形式存在的， 消息会话是公众号与用户交互的基础。 目前公众号内主要有以下几类消息服务类型，

  - 群发消息： 公众号可以以一定频次（订阅号为每天 1 次， 服务号为每月 4 次）， 向用户群发消息， 包括文字消息、 图文消息、 图片、 视频、 语音等
  - 被动回复消息：在用户给公众号发消息后，微信服务器会将消息发到开发者预先在开发者中心设置的服务器地址（开发者需要进行消息真实性验证），公众号可以在5秒内做出回复，可以回复一个消息，也可以回复命令告诉微信服务器这条消息暂不回复。被动回复消息可以设置加密（在公众平台官网的开发者中心处设置，设置后，按照消息加解密文档来进行处理。其他3种消息的调用因为是API调用而不是对请求的返回，所以不需要加解密）。
  - 客服消息：在用户给公众号发消息后的48小时内，公众号可以给用户发送不限数量的消息，主要用于客服场景。用户的行为会触发事件推送，某些事件推送是支持公众号据此发送客服消息的。
  - 模板消息：在需要对用户发送服务通知（如刷卡提醒、服务预约成功通知等）时，公众号可以用特定内容模板，主动向用户发送消息。

- 公众号内网页

  许多复杂的业务场景， 需要通过网页形式来提供服务， 这是需要用到：

  - 网页授权获取用户基本信息：通过该接口，可以获取用户的基本信息（获取用户的OpenID是无需用户同意的，获取用户的基本信息则需用户同意）
  - 微信JS-SDK：是开发者在网页上通过JavaScript代码使用微信原生功能的工具包，开发者可以使用它在网页上录制和播放微信语音、监听微信分享、上传手机本地图片、拍照等许多能力。

### 开发者规范

开发者进行公众号开发时，除了需要满足每个接口的规范限制、调用频率限制外，还需特别注意模版消息、用户数据等敏感信息的使用规范。

**涉及用户数据时**：

- 您的服务需要收集用户任何数据的，必须事先获得用户的明确同意，且仅应当收集为运营及功能实现目的而必要的用户数据， 同时应当告知用户相关数据收集的目的、范围及使用方式等，保障用户知情权。
- 您收集用户的数据后，必须采取必要的保护措施，防止用户数据被盗、泄漏等。
- 您在特定微信公众号中收集的用户数据仅可以在该特定微信公众号中使用，不得将其使用在该特定微信公众号之外或为其他任何目的进行使用，也不得以任何方式将其提供给他人。
- 如果腾讯认为您收集、使用用户数据的方式，可能损害用户体验，腾讯有权要求您删除相关数据并不得再以该方式收集、使用用户数据。
- 一旦您停止使用本服务，或腾讯基于任何原因终止您使用本服务，您必须立即删除全部因使用本服务而获得的数据（包括各种备份）， 且不得再以任何方式进行使用。

**其他规范**：

- 请勿为任何用户自动登录到微信公众平台提供代理身份验证凭据。
- 请勿提供跟踪功能，包括但不限于识别其他用户在个人主页上查看、点击等操作行为。
- 请勿自动将浏览器窗口定向到其他网页。
- 请勿设置或发布任何违反相关法规、公序良俗、社会公德等的玩法、内容等。
- 请勿公开表达或暗示，您与腾讯之间存在合作关系，包括但不限于相互持股、商业往来或合作关系等，或声称腾讯对您的认可。

## 开始开发

### 接入指南

接入微信公众平台开发， 开发者需要按照如下步骤完成：

- 填写服务器配置

  开发-基本设置页面， 勾选协议成为开发者， 点击【修改配置】， 填写服务器地址（URL）， Token 和 EncodingAESKey

  - URL： 开发者用来接收微信消息和事件的接口 URL
  - Token 可由开发者可以任意填写， 用作生成签名（该 Token 会和接口 URL 中包含的 Token进行对比， 从而验证安全性）
  - EncodingAESKey： 开发者手动填写或随机生成， 将用作消息体加解密密钥

  可以选择消息加密方式： 明文模式、 兼容模式和安全模式。 模式的选择与服务器配置在提交后都会立即生效。 默认为明文模式。 选择兼容模式和安全模式需要提前配置好相关加解密代码。

- 验证服务器地址的有效性

  开发者提交消息后， 微信服务器将发送 GET 请求到填写的服务器地址 URL 上。 开发者通过检验 signature 对请求进行校验。 若确认此次 GET 请求来自微信服务器， 请原样返回 echostr 参数内容， 则接入生效， 成为开发者成功， 否则接入失败。 加密/校验流程如下：

  - 将 token, timestamp, nonce 三个参数进行字典序排序
  - 将三个参数字符串拼接成一个字符串进行 sha1 加密
  - 开发者获得加密后的字符串可与 signature 对比， 表示该请求来源于微信

  | 参数        | 描述                                       |
  | --------- | ---------------------------------------- |
  | signature | 微信加密签名， signature 结合了开发者填写的 token 参数和请求中的 timestamp 参数、 nonce 参数 |
  | timestamp | 时间戳                                      |
  | nonce     | 随机数                                      |
  | echostr   | 随机字符串                                    |

  ```php
  private function checkSignature()
  {
  	$signature = $_GET["signature"];
  	$timestamp = $_GET["timestamp"];
  	$nonce = $_GET["nonce"];
          
  	$token = TOKEN;
  	$tmpArr = array($token, $timestamp, $nonce);
  	sort($tmpArr, SORT_STRING);
  	$tmpStr = implode( $tmpArr );
  	$tmpStr = sha1( $tmpStr );

  	if( $tmpStr == $signature ){
  		return true;
  	}else{
  		return false;
  	}
  }
  ```

- 依据接口文档实现业务逻辑


### 接入域名说明

- 通用域名： api.weixin.qq.com， 使用该域名将访问官方指定就近的接入点 
- 上海域名： sh.api.weixin.qq.com， 使用该域名将访问上海的接入点
- 深圳域名： sz.api.weixin.qq.com， 使用该域名将访问深圳的接入点
- 香港域名： hk.api.weixin.qq.com， 使用该域名将访问香港的接入点

### 获取 access_token

access_token 是公众号的全局唯一接口调用凭据， 公众号调用各接口时都需要使用 access_token。 需妥善保存， access_token 的存储至少要 512 个字符空间。 access_token 的有效期目前为 2 个小时， 需定时刷新， 重复获取将导致上次获取的 access_token 失效。

公众平台的 API 调用所需的 access_token 的使用及生成方式说明：

- 为了保密 appsecrect， 第三方需要一个 access_token 获取和刷新的中控服务器。 而其他业务逻辑服务器所使用的 access_token 均来自该中控服务器， 不应该各自去刷新， 否则会造成 access_token 覆盖而影响业务。
- 目前 access_token 的有效期通过返回的 expire_in 来传达， 目前是 7200 秒之内的值。 中控服务器需要根据这个有效时间提前去刷新新access_token。 在刷新过程中， 中控服务器对外输出的依然是老 access_token， 此时公众平台后台会保证在刷新短时间内， 新老 access_token 都可用， 这保证了第三方业务的平滑过渡。
- access_token 的有效时间可能会在未来有调整， 所以中控服务器不仅需要内部定时主动刷新， 还需要提供被动刷新 access_token 的接口， 这样便于业务服务器在 API 调用获知 access_token 已超时的情况下， 可以出发 access_token 的刷新流程。

公众号可以使用 AppID 和 AppSecret 调用本接口来获取 access_token。 **注意调用所有微信接口时均需使用 *https* 协议。 如果第三方不使用中控服务器， 而是选择各个业务逻辑点各自去刷新 access_token， 那么就可能会产生冲突， 导致服务不稳定**

## 微信网页开发

### 微信网页授权

如果用户在微信客户端中访问第三方网页， 公众号可以通过微信网页授权机制， 来获取用户基本信息， 进而实现业务逻辑。

**关于网页授权回调域名的说明**

- 在微信公众号请求用户网页授权之前， 开发者需要先到公众平台官网中的 「开发 - 接口权限 - 网页服务 - 网页授权获取用户基本信息」 的配置选项中， 修改授权回调域名。 注意， 这里填写的是域名（是一个字符串）， 而不是 URL， 因此， 勿加 `http://` 等协议头；
- 授权回调域名配置规范为全域名；
- 如果公众号登录授权给了第三方开发者来进行管理， 则不必做任何设置， 由第三方代替公众号实现网页登录授权。

**关于网页授权的两种 scope 的区别说明**：

- 以 *snsapi_base* 为 scope 发起的网页授权， 是用来获取进入页面的用户的 openid 的， 并且静默授权并自动跳转到回调页面的。 用户感知的就是直接进入了回调页(往往是业务页面)
- 以 *snspai_userinfo* 为 scope 发起的网页授权， 是用来获取用户的基本信息的， 但这种授权需要用户手动统一， 并且由于用户同意过， 所以无须关注， 就可在授权后获取该用户的基本信息。
- 用户管理类接口中的*获取用户基本信息接口*， 是在用户和公众号产生信息交互或者关注后事件推送后， 才能根据用户 OpenID 来获取用户基本信息。 这个接口， 包括其他微信接口， 都是需要该用户（即 openid） 关注了公众号后， 才能调用成功的。

**关于网页授权 access_token 和普通 access_token 的区别**：

- 微信网页授权是通过 OAuth2.0 机制实现的， 在用户授权给公众号后， 公众号可以获取到一个网页授权特有的接口调用凭证（网页授权 access_token）， 通过网页授权 access_token 可以进行授权后接口调用， 如获取用户基本信息
- ​


